<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>鲸力商旅--聪明的商旅管家</title>
    <meta name="keywords" content="鲸力商旅|鲸力商旅|鲸力商旅|聪明的贴身商旅管家|贴身商旅管家|鲸力商旅官网|鲸力商旅首页|鲸力商旅积分系统|鲸力商旅服务商| 鲸力商旅商城"/>
    <meta name="description" content="鲸力商旅&mdash;&mdash;聪明的商旅管家，boss省心，员工放心，更聪明的贴身商旅管家"/>
    <link rel="stylesheet" href="../css/Jingli.css">
    <link rel="stylesheet" href="../css/font-awesome.min.css">
</head>
<body>
<div class="JingliTech">
    <header>
        <a href="../index.html"><div class="JLlogo"></div></a>
    </header>
    <div class="content content-register">
        <div class="content-tab">
            <div class="content-tab-left active">申请试用</div>
            <div class="content-tab-right">登录</div>
        </div>
        <div id="registerContent">
            <div class="progress1">
                <span class="left">填写申请资料</span>
                <span class="right">扫码登录</span>
            </div>
            <p class="account"><span>手机号:</span><input type="text" id="mobile" placeholder="请输入11位手机号码"></p>
            <p class="account withCode"><span>验证码:</span><input type="text" id="codes" placeholder="请输入验证码"><a id="sendCode">发送验证码</a></p>
            <p class="account">
                <span style="padding-left:36px">密码:</span><input type="password" id="password" placeholder="请输入6-20位字母或数字">
            </p>
            <p class="account">
                <span style="padding-left:0px">企业名称:</span><input type="text" id="company" placeholder="请输入企业名称">
            </p>
            <p class="account"><span>联系人:</span><input type="text" id="name" placeholder="请填写您的姓名"></p>
            <a class="nextStep" id="lognext_register">下一步</a>
        </div>
        <div id="loginContent" style="display:none">
            <div class="progress1" style="margin-bottom: 52px">
                <span class="left">填写用户名密码</span>
                <span class="right">扫码登录</span>
            </div>
            <p class="account"><span style="padding-left: 0px">用户名:</span><input type="text" id="mobile_login"> </p>
            <p class="account"><span>密码:</span><input type="password" id="password_login"> </p>
            <a class="nextStep" style="margin-top: 160px" id="lognext_login">下一步</a>
        </div>
    </div>

    <footer>
        <div class="main">
            <div class="left">
                <h3>关于鲸力智享</h3>
                <p>鲸力冲开千里浪，龙光射破万层峦。——宋 陈普 《出行》<br/>释：鲸力，比喻才力非凡。</p>
                <p><a href="">了解更多>></a></p>
            </div>
            <div class="middle">
                <h3>联系我们</h3>
                <p><i class="fa fa-qq"></i>1029384721</p>
                <p><i class="fa fa-envelope-o"></i>bd@jingli365.com</p>
                <p><i class="fa fa-phone"></i>010-87630571</p>
            </div>
            <div class="right">
                <div class="scode">
                    <img src="../images/scode.png">
                </div>
                <ul>
                    <li><i class="fa fa-weibo"></i></li>
                </ul>
            </div>
        </div>
        <div class="bottom">
            <div class="main">
                <ul class="first">
                    <a href=""><li>加盟代理</li></a>
                    <a href=""><li>商务合作</li></a>
                    <a href=""><li>加入我们</li></a>
                    <a href=""><li>联系我们</li></a>
                </ul>
                <div class="third">
                    <a href="http://www.qcloud.com"><img src="../images/light_tencent.png"></a>
                </div>
                <div class="second">京ICP备102843421号-1</div>
            </div>
        </div>
    </footer>
</div>
</body>
<script src="../js/es6-shim.min.js"></script>
<script src="../js/config.local.js"></script>
<script src="../../script/libs/bundle.jquery.js"></script>
<script src="../../script/libs/bundle.browserify.js"></script>
<script src="../../script/libs/bundle.base.js"></script>
<script src="../../script/libs/bundle.preload.js"></script>
<script src="../js/qrcode.js"></script>
<script>
    var $ = require('jquery');
    var jQuery = $;
    window.Promise = require('bluebird');
    require("@jingli/zone-setup");
    window.Cookie = require('tiny-cookie');
    var storage = window.localStorage;

</script>
<script src="../js/all.js"></script>
<script src="../js/layer/layer.js"></script>
<script src="../../script/libs/bundle.ws.js"></script>
<script src="../../script/libs/bundle.api.js"></script>
<script src="../js/authenticate.js"></script>
<script>
    $(function () {
        //shiCong tab切换
        $(".content-tab div").on('click',function(){
            $(this).addClass('active').siblings('div').removeClass('active')
            var index = $(this).index();
            if(index == 0){
                $("#registerContent").show()
                $("#loginContent").hide()
            }else{
                $("#registerContent").hide()
                $("#loginContent").show()
            }
        })

        var msgTicket;
        var API = require("common/api");
        API.require("auth");
        API.require("checkcode");
        $("#sendCode").click(function(){
            var mobile = $("#mobile").val();
            if(!mobile){
                layer.msg('手机号不能为空');
                return false;
            }

            if (!/^\d{11}$/.test(mobile)) {
                layer.msg("手机号格式不正确");
                $("#mobile").focus();
                return false;
            }
            API.onload(function() {
                API.auth.registerCheckEmailMobile({mobile: mobile})
                        .then(function () {
                            return API.checkcode.getMsgCheckCode({mobile: $("#mobile").val()})
                                    .then(function (checkcode) {
                                        console.info(checkcode);
                                        msgTicket = checkcode.ticket;
                                    })
                                    .catch(function (err) {
                                        alert(err);
                                    })
                        })
                        .catch(function (err) {
                            var errMsg = "";
                            if (err.msg.indexOf("手机号已注册") != -1) {
                                errMsg = "手机";
                            }
                            layer.msg(errMsg + "已注册", {
                                time: 0, //不自动关闭
                                btn: ['换' + errMsg, '去登录'],
                                btn1: function (index) {
                                    layer.close(index);
                                },
                                btn2: function (index) {
                                    layer.close(index);
                                    $(".content-tab-right").click();
                                    //window.location.href = "login-first.html";
                                }
                            });
                        })
            })
        })

        $("#lognext_register").click(function(){
            var companyName = $("#company").val();
            var userName = $("#name").val();
            var mobile = $("#mobile").val();
            var pwd = $("#password").val();
            var msgCode = $("#codes").val();
            var email = '';
            var b = /^[0-9a-zA-Z]*$/g;

            if(!mobile){
                layer.msg('手机号不能为空');
                return false;
            }
            if(!msgCode){
                layer.msg('验证码不能为空');
                return false;
            }
            if(!pwd){
                layer.msg('密码不能为空');
                return false;
            }
            if(!companyName){
                layer.msg('公司名不能为空');
                return false;
            }
            if(!userName){
                layer.msg('姓名不能为空');
                return false;
            }



            if (!/^\d{11}$/.test(mobile)) {
                layer.msg("手机号格式不正确");
                $("#mobile").focus();
                return false;
            }

            if(pwd && (!pwd.match(b) || pwd.length<6 || pwd.length>20)){
                alert("密码必须由六位以上二十位以下的数字或字母组成");
                return false;
            }

            API.onload(function() {
                API.auth.registerCompany({mobile:mobile,name:companyName,userName:userName,pwd:pwd, msgCode:msgCode,msgTicket:msgTicket})
                        .then(function(response){
                            console.log('gfdhfd'+response);
                            return API.auth.login({email:response.mobile,pwd:pwd})
                                    .then(function (data) {
                                        storage.setItem('auth_data', JSON.stringify(data));
                                        Cookie.set("user_id", data.user_id, {expires: 30});
                                        Cookie.set("token_sign", data.token_sign, {expires: 30});
                                        Cookie.set("timestamp", data.timestamp, {expires: 30});
                                        Cookie.set("token_id", data.token_id, {expires: 30});
                                        return data;
                                    })
                                    .then(function(){
                                        window.location.href = "register-second.html";
                                    })
                        })
                        .catch(function(err){
                            alert(err);
                            console.info(err);
                        })
            })
        })


        //登录的内容

        API.authenticate = function(remote, cb) {
            var tokenId = Cookie.get("token_id");
            var userId = Cookie.get("user_id");
            var sign = Cookie.get("token_sign");
            var timestamp = Cookie.get("timestamp");
            remote.authenticate({user_id: userId, token_id: tokenId, token_sign: sign, timestamp: timestamp}, cb);
        }

        API.onload(function(){
            console.log('onload')
            $("#lognext_login").click(function(){
                var form = {
                    email:$("#mobile_login").val(),
                    pwd:$("#password_login").val()
                }
                console.log(form);
                API.auth.login(form)
                        .then(function (data) {
                            storage.setItem('auth_data', JSON.stringify(data));
                            Cookie.set("user_id", data.user_id, {expires: 30});
                            Cookie.set("token_sign", data.token_sign, {expires: 30});
                            Cookie.set("timestamp", data.timestamp, {expires: 30});
                            Cookie.set("token_id", data.token_id, {expires: 30});
                            console.info('kokooko')
                            return data;
                        })
                        .then(function(){
                            window.location.href = "login-second.html";
                        })
                        .catch(function(err){
                            alert(err)
                        })
            })
        })
    })
</script>
</html>