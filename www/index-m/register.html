<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
	<title>鲸力智享</title>
	<link rel="stylesheet" type="text/css" href="../css/style-m.css?20160715">
</head>
<body id="index">
	<header></header>
	<div class="main">
		<h2>立即加入</h2>
		<h3>只需2分钟设置即可开启智能预算管理</h3>
		<div id="companyname" class="form"><input  type="text" name="companyname" placeholder="请输入公司名称"></div>
		<div id="name" class="form"><input type="text" name="name" placeholder="你的真实姓名"></div>
		<div id="email" class="form"><input  type="text" name="email" placeholder="邮箱地址，获取通知信息，请确保可用"></div>
		<div id="mobile" class="form"><input  type="text" name="mobile" placeholder="登录用的手机号"></div>
		<div id="code" class="form">
			<p class="code">
				<input id="codes" type="text" name="code" placeholder="短信验证码（必填）">
				<a class="sendCode" id="sendCode">获取验证码</a>
                <span class="sendCode" style="display: none; color: white;background: #ccc;"><span id="countNum">90</span>s</span>
			</p>
		</div>
		<div id="password" class="form"><input  type="text" name="password" placeholder="你的密码，6-20位的字母和数字"></div>
		<a id="register">开启智能预算</a>
	</div>
	<!--<footer></footer>-->
</body>
<script src="../js/config.local.js"></script>
<script src="../js/jquery.js"></script>
<script src="../js/bundle.browserify.js"></script>
<script src="../js/bundle.base.js"></script>
<script src="../js/bundle.preload.js"></script>
<script src="../js/all.js"></script>
<script src="../js/qrcode.js"></script>
<script>
    window.Promise = require('bluebird');
    require("common/zone");
    window.Cookie = require('tiny-cookie');
</script>
<script src="../js/bundle.ws.js"></script>
<script src="../js/bundle.api.js"></script>
<script src="../js/authenticate.js"></script>
<script src="../js/layer/layer.js"></script>
<script>
    $(function(){
        API.require("auth");
        API.require("checkcode");
        var msgTicket;
        API.onload(function() {
            var emailFilter  = /^([a-zA-Z0-9_\.\-])+\@(([a-zA-Z0-9\-])+\.)+([a-zA-Z0-9]{2,4})+$/;
            $("#sendCode").click(function(){
                var $self = $(this);
                var mobile = $(":input[name=mobile]").val();
                var email = $(":input[name=email]").val();
                if(!mobile){
                    layer.msg('手机号不能为空',{skin: 'self-layer-skin'});
                    return false;
                }
                if(!email){
                    layer.msg('邮箱不能为空',{skin: 'self-layer-skin'});
                    return false;
                }
                if (!emailFilter.test(email)){
                    layer.msg("邮箱格式不正确",{skin: 'self-layer-skin'});
                    $("#email").focus();
                    return false;
                }
                if (!/^\d{11}$/.test(mobile)) {
                    layer.msg("手机号格式不正确",{skin: 'self-layer-skin'});
                    $("#mobile").focus();
                    return false;
                }
                API.auth.checkEmailAndMobile({email: email, mobile: mobile})
                        .then(function(){
                            $("#countNum").parent("span").show();
                            $self.hide();
                            //开始倒计时
                            var beginNum = $("#countNum").html()
                            function initNum() {
                                $("#countNum").parent("span").hide();
                                $self.show();
                                $("#countNum").html(beginNum);
                                clearInterval(timer);
                            }
                            var timer = setInterval(function() {
                                var num = parseInt($("#countNum").html());
                                if (num <= 0) {
                                    initNum();
                                    return;
                                }
                                $("#countNum").html(parseInt($("#countNum").html()) - 1);
                            }, 1000);


                            return API.checkcode.getMsgCheckCode({mobile: mobile})
                                    .then(function (checkcode) {
                                        msgTicket = checkcode.ticket;
                                    })
                                    .catch(function(err){
                                        alert(err.msg ? err.msg : err);
                                        initNum();
                                    })
                        })
                        .catch(function(err){
                            var errMsg = "";
                            if(err.msg.indexOf("邮箱已注册") != -1){
                                errMsg = "邮箱";
                            }else if(err.msg.indexOf("手机号已注册") != -1){
                                errMsg = "手机";
                            }

                            layer.msg(errMsg+"已注册", {
                                time: 0,
                                btn: ['换'+errMsg, '去登录'],
                                skin: 'self-layer-skin',
                                btn1: function(index){
                                    layer.close(index);
                                },
                                btn2: function(index){
                                    layer.close(index);
                                    window.location.href = "/#/login/index";
                                }
                            });
                        })
            })

            $("#register").click(function(){
                var companyName = $(":input[name=companyname]").val();
                var userName = $(":input[name=name]").val();
                var mobile = $(":input[name=mobile]").val();
                var email = $(":input[name=email]").val();
                var pwd = $(":input[name=password]").val();
                var msgCode = $(":input[name=code]").val();
                var b = /^[0-9a-zA-Z]*$/g;

                if(!companyName){
                    layer.msg('公司名不能为空',{skin: 'self-layer-skin'});
                    return false;
                }
                if(!userName){
                    layer.msg('姓名不能为空',{skin: 'self-layer-skin'});
                    return false;
                }
                if(!mobile){
                    layer.msg('手机号不能为空',{skin: 'self-layer-skin'});
                    return false;
                }
                if(!email){
                    layer.msg('邮箱不能为空',{skin: 'self-layer-skin'});
                    return false;
                }
                if(!msgCode){
                    layer.msg('验证码不能为空',{skin: 'self-layer-skin'});
                    return false;
                }
                if(!pwd){
                    layer.msg('密码不能为空',{skin: 'self-layer-skin'});
                    return false;
                }

                if (!emailFilter.test(email)){
                    layer.msg("邮箱格式不正确",{skin: 'self-layer-skin'});
                    $("#email").focus();
                    return false;
                }

                if (!/^\d{11}$/.test(mobile)) {
                    layer.msg("手机号格式不正确",{skin: 'self-layer-skin'});
                    $("#mobile").focus();
                    return false;
                }

                if(pwd && (!pwd.match(b) || pwd.length<6 || pwd.length>20)){
                    alert("密码必须由6位以上20位以下的数字或字母组成");
                    return false;
                }

                API.auth.registerCompany({mobile:mobile,name:companyName,email:email,userName:userName,pwd:pwd, msgCode:msgCode,msgTicket:msgTicket})
                        .then(function(response){
                            return API.auth.login({email:response.email,pwd:pwd})
                                    .then(function (data) {
                                        localStorage.setItem("auth_data", JSON.stringify(data));
                                        Cookie.set("user_id", data.user_id, {expires: 30});
                                        Cookie.set("token_sign", data.token_sign, {expires: 30});
                                        Cookie.set("timestamp", data.timestamp, {expires: 30});
                                        Cookie.set("token_id", data.token_id, {expires: 30});
                                        return data;
                                    })
                                    .then(function(){
                                        window.location.href = "/#/login/index";
                                        window.location.href = "/#/login/index";
                                    })
                        })
                        .catch(function(err){
                            alert(err);
                            console.info(err);
                        })
            })

        })
    })
</script>
</html>